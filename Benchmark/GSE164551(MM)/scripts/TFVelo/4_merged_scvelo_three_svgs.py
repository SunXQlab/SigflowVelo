import scanpy as sc
import scvelo as scv
import multiprocessing as mp
import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
import warnings
import os

warnings.filterwarnings("ignore")


def ensure_umap_numpy(adata, key="X_umap"):
    """Ensure adata.obsm[key] is a NumPy array (scVelo plotting expects ndarray slicing)."""
    if key not in adata.obsm:
        raise KeyError(f"adata.obsm does not contain '{key}'. Cannot plot with basis='umap'.")
    if isinstance(adata.obsm[key], pd.DataFrame):
        adata.obsm[key] = adata.obsm[key].to_numpy()
    else:
        adata.obsm[key] = np.asarray(adata.obsm[key])


def plot_velocity_stream(
    adata,
    vkey='velo_hat',
    out_svg="output/figures/streamline_prediction_of_UniTVelo2_TFvelo.svg",
):
    # Compute velocity embedding in UMAP space (writes to adata.obsm['velocity_umap'] by default)
    scv.tl.velocity_embedding(adata, basis="umap", vkey=vkey)

    ax = scv.pl.velocity_embedding_stream(
        adata,
        basis="umap",
        vkey=vkey,
        color="condition" if "condition" in adata.obs else None,
        density=2,
        smooth=0.5,
        title="RNA Velocity Stream Of TFvelo",
        show=False,
    )

    fig = ax.figure if hasattr(ax, "figure") else plt.gcf()
    fig.canvas.draw()
    fig.savefig(out_svg, format="svg", bbox_inches="tight", pad_inches=0.1, transparent=True)
    plt.close(fig)


def plot_velocity_pseudotime(
    adata,
    out_svg="output/figures/pseudotime_TFvelo.svg",
):
    # Use existing pseudotime if present; compute only if missing
    if "velo_hat_pseudotime" not in adata.obs:
        if "velo_hat_graph" not in adata.uns:
            scv.tl.velocity_graph(adata, vkey='velo_hat')
        scv.tl.velocity_pseudotime(adata, vkey='velo_hat')
    
    ax = scv.pl.scatter(
        adata,
        basis="umap",
        color='velo_hat_pseudotime',
        color_map="plasma",
        size=50,
        show=False,
    )
    ax.set_title("Pseudotime of TFvelo")

    fig = ax.figure
    fig.canvas.draw()
    fig.savefig(out_svg, format="svg", transparent=True)
    plt.close(fig)


def plot_tfvelo_latent_time(
    adata,
    layer_key="latent_t",
    out_svg="output/figures/latent_time_TFvelo.svg",
    agg="median",  # "median" or "mean"
):
    """
    Plot TFvelo latent time on UMAP.
    Note: adata.layers[layer_key] is typically (n_cells, n_genes), so we aggregate per cell.
    Creates adata.obs['TFvelo_latent_time'] and plots it.
    """
    if layer_key not in adata.layers:
        raise KeyError(f"adata.layers does not contain '{layer_key}'. Available: {list(adata.layers.keys())}")

    LT = adata.layers[layer_key]

    # Convert to dense ndarray if sparse
    if hasattr(LT, "toarray"):
        LT = LT.toarray()
    else:
        LT = np.asarray(LT)

    # Aggregate per cell (ignore NaN)
    if agg == "median":
        latent_time_cell = np.nanmedian(LT, axis=1)
    elif agg == "mean":
        latent_time_cell = np.nanmean(LT, axis=1)
    else:
        raise ValueError("agg must be 'median' or 'mean'.")

    adata.obs["TFvelo_latent_time"] = latent_time_cell

    ax = scv.pl.scatter(
        adata,
        basis="umap",
        color="TFvelo_latent_time",
        color_map="plasma",
        size=200,
        vmin=0,  # Fixed: color bar lower limit
        vmax=1,  # Fixed: color bar upper limit
        show=False,
    )

    # Fixed: force color bar ticks to show 0 and 1
    cax = ax.figure.axes[-1]  # Usually the last axes is the colorbar
    cax.set_yticks([0, 1])
    cax.set_yticklabels(["0", "1"])
    ax.set_title("TFvelo Latent Time")

    fig = ax.figure
    fig.canvas.draw()
    fig.savefig(out_svg, format="svg", transparent=True)
    plt.close(fig)


def main():
    # Create output directories if they don't exist
    os.makedirs("output/figures", exist_ok=True)
    os.makedirs("output/data", exist_ok=True)
    
    # Read data from the path generated by the previous TFvelo script
    in_h5ad = "output/data/TFvelo.h5ad"

    adata = sc.read(in_h5ad)
    print(adata)
    
    # Critical: ensure UMAP is ndarray to avoid pandas slicing errors in scVelo plotting
    ensure_umap_numpy(adata, key="X_umap")

    # Core settings
    scv.settings.n_jobs = 1

    # 1) Streamline plot
    plot_velocity_stream(
        adata,
        vkey='velo_hat',
        out_svg="output/figures/streamline_prediction_of_UniTVelo2_TFvelo.svg",
    )

    # 2) Velocity pseudotime dot plot
    plot_velocity_pseudotime(
        adata,
        out_svg="output/figures/pseudotime_TFvelo.svg",
    )

    # 3) TFvelo latent time dot plot (from adata.layers['latent_t'])
    plot_tfvelo_latent_time(
        adata,
        layer_key="latent_t",
        out_svg="output/figures/latent_time_TFvelo.svg",
        agg="median",
    )

    # Optional: save an additional file (matches your other script's behavior)
    adata.write_h5ad("output/data/adata_with_scVelo.h5ad")
    
    print("Analysis completed. Results saved to:")
    print("  - output/figures/streamline_prediction_of_UniTVelo2_TFvelo.svg")
    print("  - output/figures/pseudotime_TFvelo.svg")
    print("  - output/figures/latent_time_TFvelo.svg")
    print("  - output/data/adata_with_scVelo.h5ad")


if __name__ == "__main__":
    mp.freeze_support()
    main()